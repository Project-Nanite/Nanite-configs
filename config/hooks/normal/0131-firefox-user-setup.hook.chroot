#!/bin/bash

# Firefox User Profile Setup for Nanite Linux
# Sets up user profiles with custom settings

set -e

echo "I: Setting up Firefox user profiles..."

# Create user skeleton Firefox configuration
SKEL_FIREFOX="/etc/skel/.mozilla/firefox"
mkdir -p "$SKEL_FIREFOX"

# Create profiles.ini
cat > "$SKEL_FIREFOX/profiles.ini" << 'EOF'
[Install4F96D1932A9F858E]
Default=default-release
Locked=1

[Profile0]
Name=default
IsRelative=1
Path=default-release
Default=1

[General]
StartWithLastProfile=1
Version=2
EOF

# Create default profile directory
PROFILE_PATH="$SKEL_FIREFOX/default-release"
mkdir -p "$PROFILE_PATH"

# Create comprehensive prefs.js
cat > "$PROFILE_PATH/prefs.js" << 'EOF'
// Nanite Linux Firefox User Preferences
user_pref("browser.startup.homepage", "https://nanite.software|https://yashbhangale.github.io");
user_pref("browser.startup.page", 1);
user_pref("browser.newtabpage.enabled", true);

// Disable unwanted features
user_pref("browser.newtabpage.activity-stream.feeds.section.topstories", false);
user_pref("browser.newtabpage.activity-stream.showSponsored", false);
user_pref("browser.newtabpage.activity-stream.showSponsoredTopSites", false);
user_pref("extensions.pocket.enabled", false);
user_pref("browser.newtabpage.activity-stream.section.highlights.includeBookmarks", false);
user_pref("browser.newtabpage.activity-stream.section.highlights.includeDownloads", false);
user_pref("browser.newtabpage.activity-stream.section.highlights.includePocket", false);
user_pref("browser.newtabpage.activity-stream.section.highlights.includeVisited", false);

// Custom top sites configuration
user_pref("browser.newtabpage.activity-stream.default.sites", "https://nanite.software,https://yashbhangale.github.io,https://chat.openai.com,https://claude.ai,https://gemini.google.com,https://copilot.microsoft.com");

// Privacy and security
user_pref("privacy.trackingprotection.enabled", true);
user_pref("browser.safebrowsing.malware.enabled", true);
user_pref("browser.safebrowsing.phishing.enabled", true);
user_pref("datareporting.healthreport.uploadEnabled", false);
user_pref("toolkit.telemetry.enabled", false);
user_pref("browser.ping-centre.telemetry", false);

// Performance
user_pref("browser.cache.disk.enable", true);
user_pref("browser.cache.memory.enable", true);
user_pref("browser.sessionstore.restore_on_demand", true);
EOF

# Set proper permissions
chown -R root:root "$SKEL_FIREFOX"
chmod -R 755 "$SKEL_FIREFOX"
chmod 644 "$SKEL_FIREFOX/profiles.ini"
chmod 644 "$PROFILE_PATH/prefs.js"

echo "I: Firefox user profile setup completed!"
